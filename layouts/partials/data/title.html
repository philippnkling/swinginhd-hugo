{{- $title := .Title -}}
{{- $siteTitle := .Site.Title -}}

{{- if .IsHome -}}
    <!-- Homepage, and it's pagination -->

    <!-- Build paginator -->
    {{ $pages := where .Site.RegularPages "Section" "in" .Site.Params.mainSections }}
    {{ $notHidden := where $pages "Params.hidden" "!=" true }}
    <!-- FILTER: only present or future events -->
    {{- /* compute recentDays safely */ -}}
    {{- $rawDays := .Site.Params.recentDays -}}
    {{- $days := default 3 $rawDays -}}
    {{- /* ensure $days is an int (defensive conversion) */ -}}
    {{- $days = int $days -}}
    {{- /* compute threshold: now minus $days days */ -}}
    {{- $now := now -}}
    {{- $since := $now.AddDate 0 0 (mul -1 $days) -}}
    {{/* Optional debug: remove or comment out after testing
    <p style="color:tomato">DEBUG: recentDays={{ $days }} now={{ $now }} since={{ $since }}</p>
*/}}
    {{ $filtered := where $notHidden ".Date" "ge" $since }}
    <!-- SORT: oldest first (Date ascending) -->
    {{ $sorted := sort $filtered "Date" "asc" }}
    {{ $pag := .Paginate $sorted }}

    {{ if .Paginator.HasPrev }}
        <!-- Paginated. Append page number to title -->
        {{ $title = printf "%s - %s" .Paginator $siteTitle }}
    {{ else }}
        {{ $title = $siteTitle}}
    {{ end }}
{{- else if eq .Kind "term" -}}
    <!-- Taxonomy page -->

    <!-- Build paginator -->
    {{ $notHidden := where .Pages "Params.hidden" "!=" true }}
    <!-- FILTER: only present or future events -->
    {{- /* compute recentDays safely */ -}}
    {{- $rawDays := .Site.Params.recentDays -}}
    {{- $days := default 3 $rawDays -}}
    {{- /* ensure $days is an int (defensive conversion) */ -}}
    {{- $days = int $days -}}
    {{- /* compute threshold: now minus $days days */ -}}
    {{- $now := now -}}
    {{- $since := $now.AddDate 0 0 (mul -1 $days) -}}
    {{/* Optional debug: remove or comment out after testing
    <p style="color:tomato">DEBUG: recentDays={{ $days }} now={{ $now }} since={{ $since }}</p>
*/}}
    {{ $filtered := where $notHidden ".Date" "ge" $since }}
    <!-- SORT: oldest first (Date ascending) -->
    {{ $sorted := sort $filtered "Date" "asc" }}
    {{ $pag := .Paginate $sorted }}

    <!-- {TAXONOMY_TYPE}: {TAXONOMY_TERM} -->
    {{ $title = slice (title .Data.Singular) ": " $title }}

    {{ if .Paginator.HasPrev }}
        <!-- Add page number-->
        {{ $title = $title | append " - " .Paginator }}
    {{ end }} 

    {{ $title = $title | append " - " $siteTitle }}
    {{ $title = delimit $title "" }}
{{- end -}}

{{ return $title }}

