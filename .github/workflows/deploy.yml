name: Build and Deploy Hugo Site

on:
  push:
    branches: [master]
  repository_dispatch:
    types: [content-updated]
  schedule:
    - cron: "0 3 * * *"   # Daily rebuild at 03:00 UTC
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pages: write
      id-token: write
      actions: write

    steps:
      # 1Ô∏è‚É£ Checkout Hugo site repository
      - name: Checkout site repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2Ô∏è‚É£ Checkout external content repository
      - name: Checkout content repository
        uses: actions/checkout@v4
        with:
          repository: philippnkling/swinginhd-hugo-content
          token: ${{ secrets.SITE_REPO_TOKEN }}
          path: content-source
          ref: main

      # 3Ô∏è‚É£ Ensure content repo exists
      - name: Verify content repository checkout
        run: |
          if [ ! -d "content-source/post" ]; then
            echo "‚ùå Content repository not checked out correctly."
            exit 1
          fi

      # 4Ô∏è‚É£ Process content
      - name: Process Markdown content
        run: bash scripts/process_content.sh

      # 5Ô∏è‚É£ Setup Hugo
      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v2
        with:
          hugo-version: "latest"
          extended: true

      # 6Ô∏è‚É£ Build Hugo site
      - name: Build
        run: hugo --minify --gc --buildFuture

      # 7Ô∏è‚É£ Deploy to GitHub Pages
      - name: Deploy üöÄ
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          branch: gh-pages
          folder: public
          clean: true
          single-commit: true
